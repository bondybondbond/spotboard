console.log("üöÄ SpotBoard: Content Script Loaded");const E=!1,c=(...e)=>E;let i=!1;function C(e){if(c("üéØ Starting selector generation for:",e.tagName,e.className),e.id)return c("‚úÖ Found ID selector:",`#${e.id}`),`#${e.id}`;let t=y(e);const r=document.querySelectorAll(t);if(c(`üîç Base selector matches ${r.length} elements`),r.length===1)return t;c(`‚ö†Ô∏è Selector "${t}" matches ${r.length} elements, adding context...`),t===e.tagName.toLowerCase()&&r.length>50;const o=e.parentElement;if(o){const a=Array.from(o.children).filter(n=>n.matches(t.split("[")[0])).indexOf(e)+1;if(a>0){const n=`${t}:nth-of-type(${a})`,l=document.querySelectorAll(n);if(c(`üîç nth-of-type selector matches ${l.length} elements`),l.length===1)return n}}const s=L(e,t);return s||t}function S(e){return e.replace(/:/g,"\\:").replace(/\//g,"\\/").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\./g,"\\.").replace(/#/g,"\\#").replace(/!/g,"\\!").replace(/@/g,"\\@").replace(/\$/g,"\\$").replace(/%/g,"\\%").replace(/\^/g,"\\^").replace(/&/g,"\\&").replace(/\*/g,"\\*").replace(/\+/g,"\\+").replace(/=/g,"\\=").replace(/,/g,"\\,").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/\?/g,"\\?").replace(/~/g,"\\~")}function y(e){let t=e.tagName.toLowerCase();if(e.classList.length>0){const o=Array.from(e.classList).filter(s=>!s.includes("hover")&&!s.includes("active")).slice(0,3).map(s=>S(s));o.length>0&&(t+="."+o.join("."))}const r=["data-testid","data-component","data-section","data-module","data-type","data-t","role"];for(const o of r)if(e.hasAttribute(o)){const s=e.getAttribute(o);t+=`[${o}="${s}"]`;break}return t}function L(e,t){let r=e.parentElement;const o=[t];for(;r&&r.tagName!=="BODY"&&r.tagName!=="HTML";){if(r.id){o.unshift(`#${r.id}`);const n=o.join(" > ");if(document.querySelectorAll(n).length===1)return n}const s=["data-testid","data-component","data-section","data-module","data-type"];for(const n of s)if(r.hasAttribute(n)){const l=`${r.tagName.toLowerCase()}[${n}="${r.getAttribute(n)}"]`;o.unshift(l);const d=o.join(" > ");if(document.querySelectorAll(d).length===1)return d;o.shift()}const u=y(r);o.unshift(u);const a=o.join(" > ");if(document.querySelectorAll(a).length===1)return a;if(o.length>4)break;r=r.parentElement}return null}function m(e){if(!i)return;const t=e.target;t.style.setProperty("outline","5px solid red","important"),t.style.cursor="crosshair",e.stopPropagation()}function f(e){if(!i)return;const t=e.target;t.style.outline=""}function v(e){const t=e.cloneNode(!0);return[t,...Array.from(t.querySelectorAll("*"))].forEach(o=>{o instanceof HTMLElement&&(o.style.removeProperty("cursor"),o.style.removeProperty("outline"),o.style.length===0&&o.removeAttribute("style"))}),t.outerHTML}function h(e){if(!i)return;c("üñ±Ô∏è Click detected on:",e.target),e.preventDefault(),e.stopPropagation();const t=e.target;c("üéØ Target element:",t.tagName,t.className),t.style.setProperty("outline","5px solid #00ff00","important");let r="";if(/^H[1-6]$/i.test(t.tagName)){const a=t.textContent?.trim();a&&(r=a.length>50?a.substring(0,50)+"...":a)}if(!r){const a=t.querySelector("h1, h2, h3, h4, h5, h6");if(a?.textContent?.trim()){const n=a.textContent.trim();r=n.length>50?n.substring(0,50)+"...":n}}if(!r){const n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:l=>{const d=l.textContent?.trim();return d&&d.length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}).nextNode();if(n?.textContent?.trim()){const l=n.textContent.trim();r=l.length>50?l.substring(0,50)+"...":l}}r||(r=`Component from ${window.location.hostname}`);const o=C(t),s=v(t);c("üßπ HTML sanitized, length:",s.length,"chars");const u={id:crypto.randomUUID(),url:window.location.href,selector:o,name:r,html_cache:s,last_refresh:new Date().toISOString()};c("üì¶ Component object created:",u.id),chrome.storage.local.get(["components"],a=>{if(a.components?.length,chrome.runtime.lastError){console.error("‚ùå Chrome storage error:",chrome.runtime.lastError),alert(`‚ùå Save failed: ${chrome.runtime.lastError.message}`);return}const n=Array.isArray(a.components)?a.components:[];n.push(u),c("üìù Updated list length:",n.length),chrome.storage.local.set({components:n},()=>{if(chrome.runtime.lastError){console.error("‚ùå Chrome storage set error:",chrome.runtime.lastError),alert(`‚ùå Save failed: ${chrome.runtime.lastError.message}`);return}t.style.outline="",t.style.cursor="",alert(`‚úÖ Saved: ${r}`),g(!1)})})}function p(e){e.key==="Escape"&&i&&(g(!1),alert("‚ùå Capture Cancelled"))}function g(e){i=e!==void 0?e:!i,i?(document.addEventListener("mouseover",m,!0),document.addEventListener("mouseout",f,!0),document.addEventListener("click",h,!0),document.addEventListener("keydown",p,!0)):(document.removeEventListener("mouseover",m,!0),document.removeEventListener("mouseout",f,!0),document.removeEventListener("click",h,!0),document.removeEventListener("keydown",p,!0),document.querySelectorAll("*").forEach(t=>{t.style.outline="",t.style.cursor=""}))}chrome.runtime.onMessage.addListener((e,t,r)=>{(e.message==="TOGGLE_CAPTURE"||e.type==="TOGGLE_CAPTURE")&&g()});
